<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>osu!taiko pp calculator</title>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="osu!taiko pp calculator">
    <meta name="twitter:description" content="accurate taiko ppv2 calculator">
    <script src="https://kit.fontawesome.com/c5b454ab1b.js" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono&display=swap" rel="stylesheet">

    <style>
        .wrapper {
            font-family: 'Inter', sans-serif;
            align-items: center;
            text-align: center;
            display: flex;
            flex-wrap: wrap;

            justify-content: center;
        }
    </style>
</head>
<main class="page-content" aria-label="Content">
    <h1 class="move-in"><b>osu!taiko pp calculator</b></h1>
    <span class="move-in" style="animation-delay: .4s">based on <a href="https://osu.ppy.sh/forum/t/472288"> numbermaniac's</a> and <a
            href="https://mon.im/taikopp/">monty's</a> versions<br><br><a href="ppv1">switch to the ppv1 calculator (pre-Oct 2022)</a></span>
    <br/><br/>
    <b class="move-in" style="animation-delay: .9s">Parameters</b>
    <div class="wrapper move-in" style="animation-delay: 1.3s">
        <link rel="stylesheet" href="style.css?v=2">


            <div class="window card2" style="animation-delay: 1.3s">
                <div class="title-bar"><b>Star Rating: (DT/HT inclusive)</b><br><br></div>
                <input min="0" value="5" id="strain" type="number" step="0.1"><br>
            </div>

        <div class="window  card2" >
            <div class="title-bar"><b>Max Possible Combo:</b><br><br></div>
            <input min="0" value="500" id="numcircles" type="number"><br>
        </div>
        <div class="window card2" style="animation-delay: 1.3s">
            <div class="title-bar"><b>Overall Difficulty:</b><br><br></div>
            <input min="0" value="5" id="od-input" type="number" step="0.1" oninput="displayOD();">
            <i>
                <br><br>
                <div id="od-scaled"></div>
                <div id="od-label" style="visibility: hidden;"></div>
            </i>
        </div>
        <div class="window card2" style="animation-delay: 1.3s">
            <div class="title-bar"><b>Misses:</b><br><br></div>
            <input min="0" value="0" id="misses" type="number" oninput="setActive('misses');"><br>
        </div>
        <div class="window card2" style="animation-delay: 1.3s">
            <div class="title-bar"><b>Accuracy %:</b><br><br></div>
            <input min="0" value="99" id="acc" type="number" step="0.1" oninput="setActive('acc');"><br>
        </div>
        <div class="window card2" style="animation-delay: 1.3s">
            <div class="title-bar"><b>100s hit:</b><br><br></div>
            <input min="0" value="0" id="100s" type="number" oninput="setActive('100s');"><br>
        </div>
        <div class="window  card2" style="animation-delay: 1.3s">
            <div id="mods">
                <input id="EZ" type="checkbox"><label for="EZ"></label>
                <input id="HT" type="checkbox"><label for="HT"></label>
                <input id="HR" type="checkbox"><label for="HR"></label>
                <input id="DT" type="checkbox"><label for="DT"></label>
                <input id="HD" type="checkbox"><label for="HD"></label>
                <input id="FL" type="checkbox"><label for="FL"></label>
            </div>
        </div>
        </div>


    </div>
    <h1 id="pp" class="move-in"  style="animation-delay: 1.6s"></h1>
</main>
<script>
    window.addEventListener("DOMContentLoaded", function () {
        setActive("acc");
        displayOD();
        calcPP();

        var ez = document.getElementById("EZ");
        var hr = document.getElementById("HR");
        var ht = document.getElementById("HT");
        var dt = document.getElementById("DT");

        ez.addEventListener("click", uncheck(hr));
        hr.addEventListener("click", uncheck(ez));
        ht.addEventListener("click", uncheck(dt));
        dt.addEventListener("click", uncheck(ht));

        var inputs = document.getElementsByTagName('input');
        for (var i in inputs) {
            switch (inputs[i].type) {
                case "number":
                    inputs[i].addEventListener("input", calcPP);
                    break;
                case "checkbox":
                    inputs[i].addEventListener("click", calcPP);
                    inputs[i].addEventListener("click", displayOD);
                    break;
            }
        }
    });

    function setActive(name) {
        activeInput = name;
        if (name == "acc") {
            document.getElementById("acc").className = "active";
            document.getElementById("100s").className = "inactive";
        } else {
            document.getElementById("acc").className = "inactive";
            document.getElementById("100s").className = "active";
        }

    }

    function uncheck(elem) {
        return function () {
            elem.checked = false;
        };
    }

    function scaleOd(od) {
        if (document.getElementById("EZ").checked) {
            od /= 2;
        }
        if (document.getElementById("HR").checked) {
            od *= 1.4;
        }
        od = Math.max(Math.min(od, 10), 0);
        return od;
    };

    function hitWindow(od) {
        od = scaleOd(od);

        let hitWindow = 35

        if (od > 5) {
            hitWindow += (20 - 35) * (od - 5) / 5
        } else if (od < 5) {
            hitWindow -= (35 - 50) * (5 - od) / 5
        }

        if (document.getElementById("HT").checked) {
            hitWindow /= 0.75;
        }
        if (document.getElementById("DT").checked) {
            hitWindow /= 1.5;
        }
        // 2 decimals
        return Math.round(hitWindow * 100) / 100;
    };

    function displayOD() {
        var od = +document.getElementById("od-input").value;
        var scaled = scaleOd(od);
        scaled = Math.round(scaled * 100) / 100;
        var hitWin = hitWindow(od);

        document.getElementById("od-label").textContent = "300 Hit Window: " + hitWin + "ms";
        document.getElementById("od-scaled").textContent = "OD w/mods: " + scaled;
    };

    function calcPP() {
        let strain = +document.getElementById("strain").value;
        let hitcount = +document.getElementById("numcircles").value;
        let misses = +document.getElementById("misses").value;
        let usercombo = hitcount - misses;
        let OD300 = hitWindow(+document.getElementById("od-input").value);
        let acc = +document.getElementById("acc").value;

        const effectiveMissCount = Math.max(1.0, 1000.0 / usercombo) * misses;

        let hundreds = -1;
        if (activeInput == "acc") {
            hundreds = Math.round((1 - misses / hitcount - acc / 100) * 2 * hitcount);
            document.getElementById("100s").value = hundreds;
        } else {
            hundreds = +document.getElementById("100s").value;
            acc = 100 * (1 - misses / hitcount - hundreds / 2 / hitcount);
            // 2 decimals
            document.getElementById("acc").value = Math.round(acc * 100) / 100;
        }

        if (strain < 0 || hitcount <= 0 || misses < 0 || usercombo < 0 || acc < 0 || acc > 100 || OD300 < 0 ||
            (misses + hundreds) > hitcount || hundreds < 0) {
            document.getElementById("pp").innerHTML = "Something is wrong with at least one of your inputs."
            return;
        }

        let strainValue = Math.pow(5 * Math.max(1.0, strain / 0.115) - 4.0, 2.25) / 1150.0;
        let strainLengthBonus = 1 + 0.1 * Math.min(1.0, hitcount / 1500.0);
        let accLengthBonus = Math.min(1.15, Math.pow(hitcount / 1500.0, 0.3))

        strainValue *= strainLengthBonus;
        strainValue *= Math.pow(0.986, effectiveMissCount);
        strainValue *= Math.pow(acc / 100, 2.0);

        let accValue = Math.pow(60.0 / OD300, 1.1) * Math.pow(acc / 100, 8.0) * Math.pow(strain, 0.4) * 27.0;
        accValue *= Math.min(Math.pow(hitcount / 1500, 0.3), 1.15);

        let globalMultiplier = 1.13;
        if (document.getElementById("HD").checked) {
            globalMultiplier *= 1.075
            strainValue *= 1.025
        }

        if (document.getElementById("EZ").checked) {
            globalMultiplier *= 0.975
            strainValue *= 0.985
        }

        if (document.getElementById("FL").checked) {
            strainValue *= 1.05 * strainLengthBonus
        }

        if (document.getElementById("HR").checked) {
            strainValue *= 1.05
        }

        if (document.getElementById("HD").checked && document.getElementById("FL").checked) {
            accValue *= Math.max(1.050, 1.075 * accLengthBonus);
        }

        let totalValue = Math.pow(Math.pow(strainValue, 1.1) + Math.pow(accValue, 1.1), 1.0 / 1.1) * globalMultiplier;

        document.getElementById("pp").innerHTML = Math.round(totalValue * 1000) / 1000 + " pp"
    };
</script>
</div>
</main>
<footer id="github-link" class="site-footer">
    <a href="https://github.com/KatK1/taiko-pp-calculator" class="pagelink" style="color: beige !important;"><i
            class="fa-brands fa-github fa-2xl"></i></a>
</footer>

</body>
</html>
